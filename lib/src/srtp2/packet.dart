import 'dart:typed_data';

import 'rtp.dart';

class Packet {
  Header header;
  Uint8List payload;

  Packet(this.header, this.payload);

  factory Packet.unmarshal(Uint8List rawPacket, int offset, int arrayLen) {
    final (header, decodedOffset) =
        Header.unmarshal(rawPacket, offset, arrayLen);
    final payloadLen = arrayLen - decodedOffset;
    final payload = rawPacket.sublist(decodedOffset);
    if (header.padding) {
      if (payloadLen > 0) {
        final paddingLen = payload[payloadLen - 1];
        if (paddingLen <= payloadLen) {
          return Packet(header, payload.sublist(0, payloadLen - paddingLen));
        } else {
          throw Exception("ErrShortPacket");
        }
      } else {
        throw Exception("ErrShortPacket");
      }
    } else {
      return Packet(header, payload);
    }
  }
}

void main() {
  Packet.unmarshal(raw, 0, raw.length);
}

// final raw = Uint8List.fromList([
//   0x90,
//   0xe0,
//   0x69,
//   0x8f,
//   0xd9,
//   0xc2,
//   0x93,
//   0xda,
//   0x1c,
//   0x64,
//   0x27,
//   0x82,
//   0x00,
//   0x01,
//   0x00,
//   0x01,
//   0xff,
//   0xff,
//   0xff,
//   0xff,
//   0x98,
//   0x36,
//   0xbe,
//   0x88,
//   0x9e,
// ]);

final raw = Uint8List.fromList([
  248,
  245,
  252,
  126,
  156,
  117,
  248,
  251,
  186,
  250,
  120,
  251,
  247,
  182,
  246,
  123,
  250,
  223,
  157,
  247,
  246,
  93,
  244,
  159,
  249,
  251,
  251,
  111,
  154,
  243,
  124,
  187,
  158,
  117,
  248,
  223,
  248,
  222,
  181,
  248,
  111,
  222,
  219,
  245,
  248,
  181,
  244,
  247,
  250,
  222,
  158,
  247,
  244,
  243,
  246,
  94,
  188,
  190,
  124,
  155,
  112,
  183,
  252,
  122,
  92,
  183,
  248,
  252,
  248,
  251,
  246,
  122,
  182,
  222,
  246,
  251,
  156,
  245,
  120,
  122,
  250,
  187,
  222,
  249,
  247,
  183,
  95,
  223,
  221,
  246,
  251,
  93,
  183,
  183,
  88,
  159,
  247,
  121,
  246,
  221,
  244,
  218,
  246,
  251,
  184,
  244,
  248,
  220,
  95,
  244,
  187,
  251,
  159,
  241,
  157,
  123,
  246,
  218,
  246,
  222,
  154,
  223,
  223,
  244,
  115,
  156,
  243,
  156,
  223,
  251,
  251,
  251,
  123,
  217,
  243,
  158,
  95,
  184,
  250,
  251,
  152,
  248,
  187,
  93,
  221,
  95,
  251,
  247,
  187,
  157,
  117,
  221,
  247,
  95,
  117,
  179,
  221,
  247,
  218,
  187
]);
